\frametitle{Cohort Retention (SQL Skeleton)}
\begin{lstlisting}[language=SQL,basicstyle=\ttfamily\tiny]
WITH installs AS (
  SELECT user_id, MIN(event_ts) AS install_ts
  FROM events
  WHERE event_name = 'install'
  GROUP BY 1
),
activity AS (
  SELECT e.user_id,
         DATE_DIFF('day', i.install_ts, e.event_ts) AS dfi
  FROM events e
  JOIN installs i USING (user_id)
  WHERE e.event_name = 'app_open'
    AND e.event_ts BETWEEN i.install_ts
                        AND i.install_ts + INTERVAL '28 day'
),
dedup AS (
  SELECT user_id, dfi,
         ROW_NUMBER() OVER (
           PARTITION BY user_id, dfi ORDER BY updated_at DESC
         ) AS rn
  FROM activity
)
SELECT dfi,
       COUNT(DISTINCT CASE WHEN dfi = 0 THEN user_id END) AS n0,
       COUNT(DISTINCT CASE WHEN rn = 1 THEN user_id END) AS active,
       COUNT(DISTINCT CASE WHEN rn = 1 THEN user_id END)::float
       / NULLIF(COUNT(DISTINCT CASE WHEN dfi = 0 THEN user_id END), 0)
       AS retention
FROM dedup
GROUP BY 1
ORDER BY 1;
\end{lstlisting}
